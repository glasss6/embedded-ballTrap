<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Thief Ball Trap: Ball Trap Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Thief Ball Trap
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Ball trap documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Ball Trap Documentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
<p> This project interfaces a MMA8452Q accelerometer and nRF24 wireless module with the thief brainframe using the MSP430F5529 LaunchPad. The goal is to make a ball trap which can detect if it hits any human or object. The ball is armed by the thief brainframe then rolled. If, after a specified grace period, the ball hits a human or other desired object, the trap will send a trip message to the brainframe. If the trap does not hit any human within a specified time frame, the trap will disarm itself and send an access message to the brainframe. This trap is inspired by classic rolling boulder traps as seen in Indiana Jones films.</p>
<h1><a class="anchor" id="getting_started"></a>
Getting Started</h1>
<h2><a class="anchor" id="project_settings"></a>
Project Settings</h2>
<ul>
<li>The project uses a processor clock speed of (24MHz)</li>
<li>I2C channel 0 should be used with I2C_MAX_TX_SIZE at least 2 and I2C_MAX_RX_SIZE at least 6</li>
<li>SPI channel 1 should be used with SPI_MAX_SIZE at least 33</li>
<li>I2C and SPI should be on different channels to prevent overlapping pin assignments</li>
</ul>
<p>An example of project settings defines are shown below: </p><div class="fragment"><div class="line"><span class="preprocessor">#define FCPU 24000000</span></div><div class="line"><span class="preprocessor">#define USE_MODULE_TASK</span></div><div class="line"><span class="preprocessor">#define USE_MODULE_TIMING</span></div><div class="line"><span class="preprocessor">#define USE_MODULE_LIST</span></div><div class="line"><span class="preprocessor">#define USE_MODULE_BUFFER</span></div><div class="line"><span class="preprocessor">#define USE_MODULE_BUFFER_PRINTF</span></div><div class="line"><span class="preprocessor">#define USE_MODULE_UART</span></div><div class="line"><span class="preprocessor">#define USE_MODULE_SUBSYSTEM</span></div><div class="line"><span class="preprocessor">#define USE_UART1</span></div><div class="line"><span class="preprocessor">#define SUBSYSTEM_IO SUBSYSTEM_IO_UART</span></div><div class="line"><span class="preprocessor">#define SUBSYSTEM_UART 1</span></div><div class="line"><span class="preprocessor">#define SUBSYS_UART 1</span></div><div class="line"><span class="preprocessor">#define UART1_TX_BUFFER_LENGTH 512</span></div><div class="line"><span class="preprocessor">#define TASK_MAX_LENGTH 50</span></div><div class="line"><span class="preprocessor">#define USE_I2C0</span></div><div class="line"><span class="preprocessor">#define I2C_MAX_TX_SIZE 2</span></div><div class="line"><span class="preprocessor">#define I2C_MAX_RX_SIZE 6</span></div><div class="line"><span class="preprocessor">#define USE_SPI_B1</span></div><div class="line"><span class="preprocessor">#define SPI_MAX_SIZE 33</span></div><div class="line"><span class="preprocessor">#define THIEF_SPI SPI_B0</span></div><div class="line"><span class="preprocessor">#define THIEF_BRAINFRAME_NETWORK</span></div><div class="line"><span class="preprocessor">#define THIS_NODE BALL_TRAP</span></div></div><!-- fragment --><h2><a class="anchor" id="testing_environment"></a>
Testing Environment</h2>
<p>This project was developed using a MSP430F5529 LaunchPad and Code Composer 8.0 IDE. The embedded-software library was used for hardware abstraction. PuTTY software was used as a UART interface. Please see embedded-software library documentation for Code Composer Studio configuration. Other hardware: nRF24, Sparkfun MMA8452Q Breakout </p><dl class="section see"><dt>See also</dt><dd><a href="https://github.com/muhlbaier/embedded-software">https://github.com/muhlbaier/embedded-software</a></dd></dl>
<h2><a class="anchor" id="operation"></a>
Operation</h2>
<p>The master brainframe should send an <em>arm</em> command to the ball trap node to start operation. In case of manual operation without a master brainframe, the system can be armed using the following command in a UART terminal. </p><div class="fragment"><div class="line">$thief arm</div></div><!-- fragment --><p>Once armed, the ball should be pushed to be put in motion. The trap has an initial grace period of starting to detect human interface. The default grace period is 2s. (e.g the trap will not start detecting humans until this time has been passed, started after being armed). If the ball trap hits an object it will send a trip message to the brainframe. If the trap does not hit an object after a specified time (default 6s), it will disarm and send an access message to the brainframe.</p>
<p>Note: The trap will detect collision with any solid object. It is not limited to human detection and the threshold for collision detections is dynamic.</p>
<h1><a class="anchor" id="collision_detection"></a>
Collision Detection Calibration</h1>
<p>The accelerometer was calibrated for object detection using the following methodology:</p><ul>
<li>Read current X, Y, Z data from accelerometer every 200ms and output to UART</li>
<li>Log UART output to PuTTY and export as a CSV</li>
<li>Using Microsoft Excel, a threshold was calculated which would serve as the point at which a collision should be ticked</li>
</ul>
<p>To test, the accelerometer was placed on a rolling chair and pushed off towards a wall. When the rolling chair hits the wall, it should detect a collision. A line graph plotting the X, Y, Z data over the period of 17s in this scenario is shown in the figure below. </p><div class="image">
<img src="accel_trial1.jpg" alt="accel_trial1.jpg"/>
</div>
<p>As seen from the figure, the first smaller spike is from the chair being pushed off towards the wall. The following multiple spikes are from multiple collisions of the accelerometer with the wall. To find a reasonable threshold value, the absolute values of the X, Y, Z columns are summed together (Manhattan Distance) and (1) is subtracted from the total to normalize the constant acceleration of gravity. </p><div class="fragment"><div class="line"><span class="keywordtype">float</span> normAccel = (fabs(x) + fabs(y) + fabs(z)) - 1;</div></div><!-- fragment --><p> By analyzing the Manhattan distance of the accelerometer at certain points of collision impact, we chose an arbitrary value of 0.35f to be the threshold of a collision. E.g if any normalized acceleration distance is found above that value, it is determined to be a collision. In our tests, it is found that this value offers good collision detection suitable for our application. It is also assumed that in production, the ball will be pushed during the initial arming grace period, else the system may detect the initial push as a false positive.</p>
<p>The collision threshold determined from this calibration is defined by COLLISION_THRESHOLD definition in the <a class="el" href="main_8c.html" title="Interface with nRF24 module and accelerometer. Detect an impact using the accelerometer and report ba...">main.c</a> file. The default threshold value is 0.35f. Reducing the threshold value increases the sensitivity for detecting a collision. Inversely, increasing the threshold value increases the sensitivity for collision detection. The default threshold value is rated for a "medium speed" collision with a solid object.</p>
<h1><a class="anchor" id="accelerometer_notes"></a>
Accelerometer</h1>
<ul>
<li>The I2C module and I2C HAL for MSP430F5529 in the embedded-software library was modified to add the ability to specify if a stop-bit should be added at the end of a I2C transaction. This was added to interface with the MMA8452Q module. Anyone using this project should use the same I2C code or be updated to also support this functionality.</li>
<li>The accelerometer should use I2C channel I2C_B0 because I2C_B1 is not fully implemented in MSP430F5529 HAL</li>
<li>If the accelerometer uses I2C_B0, the nRF24 must use SPI_B1 because SPI_B0 and I2C_B0 use the same pins on MSP430F5529</li>
<li>The default scale for the accelerometer is configured for +/-2G. This can be changed in the accelerometer source code macro definition. However, in testing it was found this did not improve results.</li>
<li>The optimal sampling rate for the accelerometer (Accelerometer_Init) was found to be approximately 200ms</li>
</ul>
<h1><a class="anchor" id="Results"></a>
Results</h1>
<p>The results of the trap align with the initial project goals. The trap is able to successfully use an accelerometer to detect impact of object and then report the collision to the thief brainframe. One revision which was required from the initial project goals was the transition from a rolling ball enclosure to a rolling chair setup. If the device was in a rolling ball enclosure, it would be difficult to debug using a USB cable for UART logging (the cable would prevent smooth rolling of a ball). In addition, we determined the mechanical engineering aspect of the ball enclosure would distract us from the main embedded software focus.</p>
<p>The resulting project aligns with the principles of good embedded software design. Our code is clean, modular, and reusable. The accelerometer code was written simply so anyone can simply include the module and read data from the sensor. The ball trap portion of the code is well documented and has optional debug logging to UART by (un)commenting a user-define. Additionally, the methodology of our collision detection calibration was clearly outlined and defined so any additional user of our trap can understand how we came to our results and modify it for their use-case if need be.</p>
<h1><a class="anchor" id="technology_usage"></a>
Technology Usage</h1>
<h2><a class="anchor" id="Slack"></a>
Slack</h2>
<p>Slack was useful for easily communicating with our team-members. A Slack private channel was created for our team and we communicated mostly in that channel for: discussion for due dates, project goals, logistics, etc. Overall, it was helpful.</p>
<h2><a class="anchor" id="Trello"></a>
Trello</h2>
<p>Trello was useful for staying organizing and to understand what the goals and deadlines were for each sprint. Additionally, everyone was able to see each group members' individual contributions to a task. Overall, Trello was useful for the project and solving the logisitics of a group project.</p>
<h1><a class="anchor" id="authors"></a>
Authors</h1>
<ul>
<li>Stephen Glass</li>
<li>Lonnie Souder</li>
</ul>
<h1><a class="anchor" id="Appendix"></a>
Appendix</h1>
<div class="image">
<img src="prototype.jpg" alt="prototype.jpg"/>
</div>
 </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
